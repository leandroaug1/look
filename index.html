<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Style ERP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #f4f6f9; min-height: 100vh; padding-bottom: 70px; }
    #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .look-card { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .look-img-part { height: 150px; background-size: cover; background-position: center; width: 50%; display: inline-block; border: 1px solid #fff; }
    .nav-bottom { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 10px; display: flex; justify-content: space-around; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
    .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-bottom: 10px; cursor: pointer; background: white; border-radius: 8px; }
    .hidden { display: none !important; }
    .nav-btn { display: flex; flex-direction: column; align-items: center; background: none; border: none; font-size: 0.8rem; color: #6c757d; }
    .nav-btn i { font-size: 1.2rem; margin-bottom: 2px; }
    .nav-btn.active { color: #0d6efd; font-weight: bold; }
  </style>
</head>
<body>

  <script>
    // Link do script (backend)
    const API_URL = "https://script.google.com/macros/s/AKfycbw-M8DKCPjeUlIHe5_tsPnBjT7cNuy3iTWYYZ1IuXM250iT0CL7GlhtklfCrXEq7X54Jg/exec"; 
  </script>

  <div id="loader-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <h5 class="mt-3" id="loader-text">Conectando ao Banco de Dados...</h5>
  </div>

  <div class="container mt-4">
    
    <div id="view-dashboard">
      <h2 class="mb-4 fw-light">Dashboard</h2>
      <div id="stats-area" class="row mb-3">
        <div class="col-6"><div class="card bg-primary text-white p-3 shadow-sm"><h3><span id="st-total">0</span></h3><small>Looks Totais</small></div></div>
        <div class="col-6"><div class="card bg-success text-white p-3 shadow-sm"><h3><span id="st-used">0</span></h3><small>Usados</small></div></div>
      </div>
      <h5 class="mt-4 mb-3 text-muted">Minhas Cole√ß√µes</h5>
      <div id="list-collections"></div>
    </div>

    <div id="view-create" class="hidden">
      <h2 class="mb-4 fw-light">Novo Planejamento</h2>
      <div class="card p-3 shadow-sm border-0">
        <input type="text" id="new-name" class="form-control mb-3" placeholder="Nome da Cole√ß√£o (ex: Trabalho)">
        <select id="new-mode" class="form-select mb-3">
          <option value="2pc">2 Pe√ßas (Camisa + Cal√ßa)</option>
          <option value="3pc">3 Pe√ßas (+ Cal√ßado)</option>
        </select>
        
        <div class="upload-area" onclick="document.getElementById('fA').click()">Parte de Cima üëï <br><strong id="cA" class="text-primary">0 fotos</strong></div>
        <input type="file" id="fA" hidden multiple accept="image/*" onchange="countFiles(this,'cA')">
        
        <div class="upload-area" onclick="document.getElementById('fB').click()">Parte de Baixo üëñ <br><strong id="cB" class="text-primary">0 fotos</strong></div>
        <input type="file" id="fB" hidden multiple accept="image/*" onchange="countFiles(this,'cB')">
        
        <div class="upload-area" onclick="document.getElementById('fC').click()">Cal√ßado üëü <br><strong id="cC" class="text-primary">0 fotos</strong></div>
        <input type="file" id="fC" hidden multiple accept="image/*" onchange="countFiles(this,'cC')">

        <button class="btn btn-primary w-100 mt-3 p-3" onclick="sendData()">‚ú® Gerar Combina√ß√µes</button>
      </div>
    </div>

    <div id="view-details" class="hidden">
      <button class="btn btn-outline-secondary mb-3 btn-sm" onclick="showView('dashboard')">‚Üê Voltar</button>
      <h3 id="det-title" class="mb-3">Galeria</h3>
      <div id="det-grid" class="row"></div>
    </div>

  </div>

  <div class="nav-bottom">
    <button class="nav-btn active" onclick="showView('dashboard')" id="btn-dash"><i class="bi bi-grid-fill"></i>Dashboard</button>
    <button class="nav-btn" onclick="showView('create')" id="btn-create"><i class="bi bi-plus-circle-fill"></i>Novo</button>
    <button class="nav-btn" onclick="init()"><i class="bi bi-arrow-clockwise"></i>Atualizar</button>
  </div>

  <script>
    let filesA=[], filesB=[], filesC=[];

    // --- FUN√á√ïES DE API ---
    async function apiGet(action, params = "") {
      try {
        const res = await fetch(`${API_URL}?action=${action}${params}`);
        const json = await res.json();
        return json;
      } catch(e) { 
        console.error(e);
        // AVISO REMOVIDO AQUI: Se der erro, ele apenas loga no console e n√£o mostra o alerta na tela.
        return null; 
      }
    }

    async function apiPost(data) {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(data),
        headers: { "Content-Type": "text/plain;charset=utf-8" }
      });
      return await res.json();
    }

    // --- L√ìGICA ---
    window.onload = init;

    function showView(id) {
      document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
      document.getElementById('view-'+id).classList.remove('hidden');
      
      document.getElementById('btn-dash').classList.remove('active');
      document.getElementById('btn-create').classList.remove('active');
      if(id === 'dashboard') document.getElementById('btn-dash').classList.add('active');
      if(id === 'create') document.getElementById('btn-create').classList.add('active');
    }

    async function init() {
      document.getElementById('loader-overlay').classList.remove('hidden');
      const data = await apiGet('getDashboard');
      document.getElementById('loader-overlay').classList.add('hidden');
      
      if(!data) return; // Se falhar silenciosamente, apenas para aqui.
      if(data.error) { alert(data.error); return; }
      
      document.getElementById('st-total').innerText = data.stats.total;
      document.getElementById('st-used').innerText = data.stats.used;
      
      let html = '';
      if(data.collections.length === 0) {
        html = '<div class="alert alert-light text-center">Nenhuma cole√ß√£o encontrada.</div>';
      } else {
        html = '<ul class="list-group">';
        data.collections.forEach(c => {
          html += `<li class="list-group-item d-flex justify-content-between align-items-center">
            <div><strong>${c.name}</strong><br><small class="text-muted">${c.used}/${c.count} looks</small></div>
            <div>
              <button class="btn btn-sm btn-primary" onclick="loadDetails('${c.id}','${c.name}')">Ver</button>
              <button class="btn btn-sm btn-outline-danger" onclick="doDelete('${c.id}')"><i class="bi bi-trash"></i></button>
            </div>
          </li>`;
        });
        html += '</ul>';
      }
      document.getElementById('list-collections').innerHTML = html;
    }

    async function loadDetails(id, name) {
      document.getElementById('loader-overlay').classList.remove('hidden');
      document.getElementById('loader-text').innerText = "Baixando fotos (isso pode demorar um pouco)...";
      
      const data = await apiGet('getDetails', `&id=${id}`);
      document.getElementById('loader-overlay').classList.add('hidden');
      
      if(!data) return;

      document.getElementById('det-title').innerText = name;
      let html = '';
      data.forEach(l => {
        let imgs = `<div class="look-img-part" style="background-image:url(${l.imgA})"></div><div class="look-img-part" style="background-image:url(${l.imgB})"></div>`;
        if(l.imgC) imgs += `<div class="look-img-part" style="background-image:url(${l.imgC})"></div>`;
        
        const btnClass = l.status === 'USADO' ? 'btn-success' : 'btn-outline-secondary';
        const btnText = l.status === 'USADO' ? '‚úÖ Utilizado' : 'Marcar como Usado';

        html += `<div class="col-md-4 col-sm-6"><div class="look-card">
          <div class="p-2 fw-bold bg-light d-flex justify-content-between"><span>${l.day}</span> <small>${l.week}</small></div>
          <div style="display:flex; height:150px">${imgs}</div>
          <div class="p-2"><button id="btn-${l.rowIndex}" class="btn w-100 ${btnClass}" onclick="setStatus(${l.rowIndex}, '${l.status}')">${btnText}</button></div>
        </div></div>`;
      });
      document.getElementById('det-grid').innerHTML = html;
      showView('details');
    }

    function countFiles(inp, spanId) {
      const list = inp.id === 'fA' ? filesA : (inp.id === 'fB' ? filesB : filesC);
      list.length = 0;
      Array.from(inp.files).forEach(f => list.push(f));
      document.getElementById(spanId).innerText = list.length + " fotos selecionadas";
    }

    function compress(file) {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = e => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const cvs = document.createElement('canvas');
            const scale = 600 / img.width; // Reduz para 600px
            cvs.width = 600;
            cvs.height = img.height * scale;
            cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
            resolve(cvs.toDataURL('image/jpeg', 0.6));
          }
        }
      });
    }

    async function sendData() {
      const name = document.getElementById('new-name').value;
      const mode = document.getElementById('new-mode').value;
      if(!name || filesA.length===0 || filesB.length===0) return alert("Preencha o nome e selecione as fotos!");

      document.getElementById('loader-text').innerText = "Comprimindo e enviando para o Google...";
      document.getElementById('loader-overlay').classList.remove('hidden');

      const bA = await Promise.all(filesA.map(compress));
      const bB = await Promise.all(filesB.map(compress));
      const bC = await Promise.all(filesC.map(compress));

      const payload = { action: 'create', name, mode, imgsA: bA, imgsB: bB, imgsC: bC };
      
      const res = await apiPost(payload);
      document.getElementById('loader-overlay').classList.add('hidden');

      if(res && res.success) {
        alert("Criado com sucesso!");
        filesA=[]; filesB=[]; filesC=[];
        document.getElementById('new-name').value = "";
        document.getElementById('cA').innerText = "0 fotos";
        document.getElementById('cB').innerText = "0 fotos";
        document.getElementById('cC').innerText = "0 fotos";
        init();
        showView('dashboard');
      } else {
        alert("Erro ao criar: " + (res ? res.error : "Desconhecido"));
      }
    }

    async function setStatus(row, current) {
      const newS = current === 'USADO' ? '' : 'USADO';
      const btn = document.getElementById(`btn-${row}`);
      btn.innerText = "Salvando...";
      
      await apiPost({ action: 'setStatus', rowIndex: row, status: newS });
      
      if(newS === 'USADO') {
        btn.className = "btn w-100 btn-success";
        btn.innerText = "‚úÖ Utilizado";
        btn.onclick = () => setStatus(row, 'USADO');
      } else {
        btn.className = "btn w-100 btn-outline-secondary";
        btn.innerText = "Marcar como Usado";
        btn.onclick = () => setStatus(row, '');
      }
    }

    async function doDelete(id) {
      if(confirm("Tem certeza que deseja apagar essa cole√ß√£o e todas as fotos?")) {
        document.getElementById('loader-overlay').classList.remove('hidden');
        await apiPost({ action: 'delete', colId: id });
        init();
      }
    }
  </script>
</body>
</html>
