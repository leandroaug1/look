<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Style ERP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    /* Estilos Simplificados */
    body { background-color: #f4f6f9; min-height: 100vh; padding-bottom: 50px; }
    #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .look-card { background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .look-img-part { height: 150px; background-size: cover; background-position: center; width: 50%; display: inline-block; }
    .nav-bottom { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 10px; display: flex; justify-content: space-around; }
    .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-bottom: 10px; cursor: pointer; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <script>
    const API_URL = "COLE_SEU_LINK_EXEC_AQUI"; 
  </script>

  <div id="loader-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <h5 class="mt-3" id="loader-text">Conectando ao ERP...</h5>
  </div>

  <div class="container mt-4 mb-5">
    
    <div id="view-dashboard">
      <h2 class="mb-4">Dashboard</h2>
      <div id="stats-area" class="row mb-3">
        <div class="col-6"><div class="card bg-primary text-white p-3"><h3><span id="st-total">0</span> Looks</h3></div></div>
        <div class="col-6"><div class="card bg-success text-white p-3"><h3><span id="st-used">0</span> Usados</h3></div></div>
      </div>
      <div id="list-collections"></div>
    </div>

    <div id="view-create" class="hidden">
      <h2>Novo Planejamento</h2>
      <input type="text" id="new-name" class="form-control mb-3" placeholder="Nome da ColeÃ§Ã£o">
      <select id="new-mode" class="form-select mb-3">
        <option value="2pc">2 PeÃ§as (Camisa + CalÃ§a)</option>
        <option value="3pc">3 PeÃ§as (+ CalÃ§ado)</option>
      </select>
      
      <div class="upload-area" onclick="document.getElementById('fA').click()">Parte de Cima ðŸ‘• <span id="cA">0</span></div>
      <input type="file" id="fA" hidden multiple accept="image/*" onchange="countFiles(this,'cA')">
      
      <div class="upload-area" onclick="document.getElementById('fB').click()">Parte de Baixo ðŸ‘– <span id="cB">0</span></div>
      <input type="file" id="fB" hidden multiple accept="image/*" onchange="countFiles(this,'cB')">
      
      <div class="upload-area" onclick="document.getElementById('fC').click()">CalÃ§ado ðŸ‘Ÿ <span id="cC">0</span></div>
      <input type="file" id="fC" hidden multiple accept="image/*" onchange="countFiles(this,'cC')">

      <button class="btn btn-primary w-100 mt-3" onclick="sendData()">Gerar Looks</button>
    </div>

    <div id="view-details" class="hidden">
      <button class="btn btn-secondary mb-3" onclick="showView('dashboard')">Voltar</button>
      <h3 id="det-title">Galeria</h3>
      <div id="det-grid" class="row"></div>
    </div>

  </div>

  <div class="nav-bottom">
    <button class="btn btn-light" onclick="showView('dashboard')">ðŸ“Š Dash</button>
    <button class="btn btn-light" onclick="showView('create')">âž• Novo</button>
    <button class="btn btn-light" onclick="init()">ðŸ”„ Atualizar</button>
  </div>

  <script>
    let filesA=[], filesB=[], filesC=[];

    // --- FUNÃ‡Ã•ES DE API ---
    async function apiGet(action, params = "") {
      if(API_URL.includes("COLE_SEU")) { alert("Configure o link da API no cÃ³digo!"); return null; }
      const res = await fetch(`${API_URL}?action=${action}${params}`);
      return await res.json();
    }

    async function apiPost(data) {
      if(API_URL.includes("COLE_SEU")) { alert("Configure o link da API!"); return null; }
      // O Google requer que usemos 'no-cors' ou stringify no body para post simples
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(data)
      });
      return await res.json();
    }

    // --- LÃ“GICA ---
    window.onload = init;

    function showView(id) {
      document.getElementById('view-dashboard').classList.add('hidden');
      document.getElementById('view-create').classList.add('hidden');
      document.getElementById('view-details').classList.add('hidden');
      document.getElementById('view-'+id).classList.remove('hidden');
    }

    async function init() {
      document.getElementById('loader-overlay').classList.remove('hidden');
      try {
        const data = await apiGet('getDashboard');
        document.getElementById('loader-overlay').classList.add('hidden');
        
        if(data.error) { alert(data.error); return; }
        
        document.getElementById('st-total').innerText = data.stats.total;
        document.getElementById('st-used').innerText = data.stats.used;
        
        let html = '<ul class="list-group">';
        data.collections.forEach(c => {
          html += `<li class="list-group-item d-flex justify-content-between align-items-center">
            ${c.name} (${c.used}/${c.count})
            <div>
              <button class="btn btn-sm btn-primary" onclick="loadDetails('${c.id}','${c.name}')">Ver</button>
              <button class="btn btn-sm btn-danger" onclick="doDelete('${c.id}')">X</button>
            </div>
          </li>`;
        });
        document.getElementById('list-collections').innerHTML = html + '</ul>';
      } catch(e) {
        alert("Erro de conexÃ£o. Verifique o link da API.");
        document.getElementById('loader-overlay').classList.add('hidden');
      }
    }

    async function loadDetails(id, name) {
      document.getElementById('loader-overlay').classList.remove('hidden');
      document.getElementById('loader-text').innerText = "Baixando fotos (pode demorar)...";
      
      const data = await apiGet('getDetails', `&id=${id}`);
      document.getElementById('loader-overlay').classList.add('hidden');
      
      document.getElementById('det-title').innerText = name;
      let html = '';
      data.forEach(l => {
        let imgs = `<div class="look-img-part" style="background-image:url(${l.imgA})"></div><div class="look-img-part" style="background-image:url(${l.imgB})"></div>`;
        if(l.imgC) imgs += `<div class="look-img-part" style="background-image:url(${l.imgC})"></div>`;
        
        html += `<div class="col-md-4"><div class="look-card">
          <div class="p-2 fw-bold bg-light">${l.day} - ${l.week}</div>
          <div style="display:flex; height:150px">${imgs}</div>
          <div class="p-2"><button class="btn w-100 ${l.status==='USADO'?'btn-success':'btn-secondary'}" onclick="setStatus(${l.rowIndex}, '${l.status}')">${l.status||'Marcar'}</button></div>
        </div></div>`;
      });
      document.getElementById('det-grid').innerHTML = html;
      showView('details');
    }

    // --- UPLOAD ---
    function countFiles(inp, spanId) {
      const list = inp.id === 'fA' ? filesA : (inp.id === 'fB' ? filesB : filesC);
      list.length = 0;
      Array.from(inp.files).forEach(f => list.push(f));
      document.getElementById(spanId).innerText = list.length + " arquivos";
    }

    function compress(file) {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = e => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const cvs = document.createElement('canvas');
            const scale = 600 / img.width;
            cvs.width = 600;
            cvs.height = img.height * scale;
            cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
            resolve(cvs.toDataURL('image/jpeg', 0.6));
          }
        }
      });
    }

    async function sendData() {
      const name = document.getElementById('new-name').value;
      const mode = document.getElementById('new-mode').value;
      if(!name || filesA.length===0 || filesB.length===0) return alert("Preencha tudo!");

      document.getElementById('loader-text').innerText = "Comprimindo e enviando...";
      document.getElementById('loader-overlay').classList.remove('hidden');

      const bA = await Promise.all(filesA.map(compress));
      const bB = await Promise.all(filesB.map(compress));
      const bC = await Promise.all(filesC.map(compress));

      const payload = { action: 'create', name, mode, imgsA: bA, imgsB: bB, imgsC: bC };
      await apiPost(payload);
      
      alert("Criado com sucesso!");
      filesA=[]; filesB=[]; filesC=[];
      document.getElementById('new-name').value = "";
      init();
      showView('dashboard');
    }

    async function setStatus(row, current) {
      const newS = current === 'USADO' ? '' : 'USADO';
      await apiPost({ action: 'setStatus', rowIndex: row, status: newS });
      // Recarrega a view atual (simplificado)
      alert("Atualizado!");
    }

    async function doDelete(id) {
      if(confirm("Apagar?")) {
        await apiPost({ action: 'delete', colId: id });
        init();
      }
    }
  </script>
</body>
</html>
